<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Аналитическая Карта Казахстана</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* ОСНОВНЫЕ СТИЛИ */
    html,body{margin:0;padding:0;height:100%;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;overflow:hidden; font-size: 13px;}
    #map{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;background:#f8fbff}
    
    /* УПРАВЛЕНИЕ УРОВНЯМИ */
    .admin-switch-container { 
        position: absolute; top: 15px; left: 50%; transform: translateX(-50%); 
        z-index: 1000; background: white; padding: 6px 15px; 
        border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
        display: flex; align-items: center; gap: 5px; 
    }
    .level-btn { 
        border: none; background: transparent; cursor: pointer; 
        color: #555; font-size: 12px; font-weight: 700; 
        padding: 6px 12px; border-radius: 20px; 
        transition: all 0.2s; text-transform: uppercase; 
        letter-spacing: 0.5px;
    }
    .level-btn:hover { background: #f0f0f0; color: #333; }
    .level-btn.active { background: #1976D2; color: white; box-shadow: 0 2px 6px rgba(25, 118, 210, 0.4); }
    .level-separator { color: #ccc; font-size: 14px; user-select: none; }

    /* ЛЕВАЯ ПАНЕЛЬ */
    .sidebar { position: absolute; top: 15px; left: 15px; width: 320px; background: rgba(255,255,255,0.98); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; max-height: calc(100vh - 50px); overflow-y: auto; display: flex; flex-direction: column; }
    .sidebar-header { padding: 12px 15px; background: #2c3e50; color: white; font-weight: 600; font-size: 14px; border-radius: 8px 8px 0 0; }
    
    .accordion-item { border-bottom: 1px solid #eee; }
    .accordion-header { width: 100%; padding: 12px 15px; background: white; border: none; text-align: left; cursor: pointer; font-size: 12px; font-weight: 600; color: #444; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
    .accordion-header i { width: 20px; text-align: center; color: #1976D2; }
    .accordion-header:hover { background: #f7f9fc; color: #1976D2; }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #fcfdff; }
    .accordion-item.active .accordion-content { max-height: 100vh; overflow-y: auto; }

    /* ЭЛЕМЕНТЫ УПРАВЛЕНИЯ СЛОЕМ */
    .layer-control-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 15px; border-bottom: 1px solid #f0f0f0; }
    .layer-control-left { display: flex; align-items: center; gap: 8px; flex-grow: 1; }
    .layer-name-btn { border: none; background: none; text-align: left; cursor: pointer; font-size: 11.5px; color: #555; padding: 0; flex-grow: 1; }
    .layer-name-btn.active { color: #1976D2; font-weight: 700; }
    input[type="checkbox"] { cursor: pointer; accent-color: #1976D2; }
    input[type="range"] { width: 60px; height: 4px; cursor: pointer; }

    /* ПРАВАЯ ПАНЕЛЬ */
    #stats-panel { 
        position: absolute; top: 15px; right: 15px; width: 360px; 
        background: rgba(255, 255, 255, 0.96); padding: 12px; 
        border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
        z-index: 1000; display: flex; flex-direction: column; 
        transition: all 0.3s ease; 
    }
    #stats-panel.expanded { width: 80%; height: 80%; top: 10%; right: 10%; padding: 30px; z-index: 2000; }
    #stats-panel.expanded .chart-container { height: 100% !important; flex-grow: 1; }
    .panel-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 8px; }
    #region-title { margin: 0; color: #2c3e50; font-size: 13px; font-weight: bold; }
    .expand-btn { background: none; border: none; cursor: pointer; color: #555; font-size: 14px; }
    .chart-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 8px; }
    .chart-selector button { border: 1px solid #ddd; background: #f8f9fa; padding: 4px; font-size: 10px; font-weight: 600; color: #555; cursor: pointer; border-radius: 4px; }
    .chart-selector button.active { background: #3498db; color: white; border-color: #2980b9; }
    .chart-container { position: relative; height: 180px; width: 100%; transition: height 0.3s; }
    
    .panel-buttons { display: flex; gap: 8px; margin-top: 8px; }
    .action-btn { flex: 1; padding: 8px; text-align: center; text-decoration: none; border-radius: 4px; font-size: 12px; font-weight: bold; transition: background 0.2s; display: none; }
    .btn-stat { background: #2c3e50; color: white; }
    .btn-stat:hover { background: #34495e; }
    .btn-map { background: #1976D2; color: white; }
    .btn-map:hover { background: #1565c0; }
    
    /* ЛЕГЕНДА */
    .legend { position:absolute; bottom:25px; right:15px; background:white; padding:10px; border-radius:6px; box-shadow:0 2px 10px rgba(0,0,0,.15); font-size:11px; z-index:999; }
    .legend-title { margin-bottom:5px; font-weight:bold; }
    .legend-item { display:flex; align-items:center; gap:6px; margin:2px 0; }
    .legend-color { width:18px; height:12px; border:1px solid #ccc; }

    /* ПОПАПЫ */
    .leaflet-popup-content-wrapper { border-radius: 8px; overflow: hidden; padding: 0; }
    .leaflet-popup-content { margin: 0; width: 100% !important; min-width: 380px; }
    .popup-header { background:#1976D2; color:white; padding:10px 15px; font-weight:bold; font-size:14px; }
    .popup-sub { font-size: 11px; font-weight: normal; opacity: 0.9; display: block; margin-top: 2px; }
    .popup-body { padding: 10px 15px; font-size: 12px; max-height: 400px; overflow-y: auto; }
    .popup-row { display:flex; justify-content:space-between; padding: 6px 0; border-bottom:1px solid #f0f0f0; align-items: center; }
    .popup-label { color: #555; font-weight: 500; }
    .popup-value { font-weight:700; color:#333; text-align: right; }
    
    .popup-btn-link { display: block; margin-top: 10px; padding: 8px 12px; background-color: #1976D2; color: white; text-align: center; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 12px; transition: background 0.2s; }
    .popup-btn-link:hover { background-color: #1565c0; color: white !important; }
    .popup-btn-link, .popup-btn-link:visited, .popup-btn-link:active { color: white !important; }

    /* БАЛАНС (Grid Style) */
    .balance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: start; }
    .balance-col { display: flex; flex-direction: column; gap: 8px; }
    .balance-flow-item { border-bottom: 1px solid #eee; padding-bottom: 8px; font-size: 11.5px; line-height: 1.3; }
    .balance-flow-item:last-child { border-bottom: none; }
    .bal-prod { font-weight: 700; color: #000; display: block; margin-bottom: 2px; }
    .bal-region { color: #444; display: block; margin-bottom: 1px; }
    .bal-markup { font-weight: 600; display: block; margin-top: 2px; }
    
    .markup-green { color: #2e7d32; } .markup-red { color: #c62828; } .markup-yellow { color: #f9a825; }

    @media (max-width: 420px) { .balance-grid { grid-template-columns: 1fr; } }

    #mapTransitionLoader { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9); display:none;align-items:center;justify-content:center;z-index:9999;flex-direction:column; }
</style>
</head>
<body>

<div id="map"></div>

<div class="admin-switch-container">
    <button class="level-btn active" id="btn-lvl-republic" onclick="manualSwitchLevel('republic')" title="Уровень Республики Казахстан">РЕСПУБЛИКА</button>
    <span class="level-separator">→</span>
    <button class="level-btn" id="btn-lvl-oblast" onclick="manualSwitchLevel('oblast')" title="Областной уровень">ОБЛАСТЬ</button>
    <span class="level-separator">→</span>
    <button class="level-btn" id="btn-lvl-district" onclick="manualSwitchLevel('district')" title="Районный уровень">РАЙОН</button>
    <span class="level-separator">→</span>
    <button class="level-btn" id="btn-lvl-town" onclick="manualSwitchLevel('town')" title="Населенные пункты">Н.П.</button>
</div>

<div class="sidebar">
    <div class="sidebar-header">Слои карты</div>
    
    <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)"><i class="fa-solid fa-circle-info"></i> 1. Общие сведения</button>
        <div class="accordion-content">
            <div class="layer-control-row">
                <div class="layer-control-left">
                    <input type="checkbox" onchange="toggleLayerVisibility(this, 'population')">
                    <button class="layer-name-btn" data-metric="population" onclick="toggleCheckbox('population')">Численность населения</button>
                </div>
                <input type="range" min="0" max="1" step="0.1" value="0.3" oninput="changeLayerOpacity(this.value, 'population')" title="Прозрачность">
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)"><i class="fa-solid fa-shield-halved"></i> 2. Безопасность и правопорядок</button>
        <div class="accordion-content">
            <div class="layer-control-row">
                <div class="layer-control-left">
                    <input type="checkbox" onchange="toggleLayerVisibility(this, 'crime')">
                    <button class="layer-name-btn" data-metric="crime" onclick="toggleCheckbox('crime')">Уровень преступности</button>
                </div>
                <input type="range" min="0" max="1" step="0.1" value="0.3" oninput="changeLayerOpacity(this.value, 'crime')" title="Прозрачность">
            </div>
        </div>
    </div>

    <div class="accordion-item active">
        <button class="accordion-header" onclick="toggleAccordion(this)"><i class="fa-solid fa-coins"></i> 3. Экономика и торговля</button>
        <div class="accordion-content">
            <div class="layer-control-row">
                <div class="layer-control-left">
                    <input type="checkbox" onchange="toggleLayerVisibility(this, 'vvp')">
                    <button class="layer-name-btn" data-metric="vvp" onclick="toggleCheckbox('vvp')">ВРП на душу</button>
                </div>
                <input type="range" min="0" max="1" step="0.1" value="0.3" oninput="changeLayerOpacity(this.value, 'vvp')" title="Прозрачность">
            </div>
            <div class="layer-control-row">
                <div class="layer-control-left">
                    <input type="checkbox" onchange="toggleLayerVisibility(this, 'retail')">
                    <button class="layer-name-btn" data-metric="retail" onclick="toggleCheckbox('retail')">Розничная торговля</button>
                </div>
                <input type="range" min="0" max="1" step="0.1" value="0.3" oninput="changeLayerOpacity(this.value, 'retail')" title="Прозрачность">
            </div>
            <div class="layer-control-row">
                <div class="layer-control-left">
                    <input type="checkbox" onchange="toggleLayerVisibility(this, 'wholesale')">
                    <button class="layer-name-btn" data-metric="wholesale" onclick="toggleCheckbox('wholesale')">Оптовая торговля</button>
                </div>
                <input type="range" min="0" max="1" step="0.1" value="0.3" oninput="changeLayerOpacity(this.value, 'wholesale')" title="Прозрачность">
            </div>
            <div class="layer-control-row">
                <div class="layer-control-left">
                    <input type="checkbox" onchange="toggleLayerVisibility(this, 'balance')">
                    <button class="layer-name-btn" data-metric="balance" onclick="toggleCheckbox('balance')">Продовольственный баланс</button>
                </div>
                <input type="range" min="0" max="1" step="0.1" value="0.3" oninput="changeLayerOpacity(this.value, 'balance')" title="Прозрачность">
            </div>
            <div class="layer-control-row"><div class="layer-control-left"><input type="checkbox" id="fairsToggle"> <span>Ярмарки</span></div></div>
            <div class="layer-control-row"><div class="layer-control-left"><input type="checkbox" id="storageToggle"> <span>Овощехранилища</span></div></div>
        </div>
    </div>

    <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)"><i class="fa-solid fa-city"></i> 4. Строительство и инфраструктура</button>
        <div class="accordion-content">
            <div class="layer-control-row">
                <div class="layer-control-left">
                    <input type="checkbox" onchange="toggleLayerVisibility(this, 'queue')">
                    <button class="layer-name-btn" data-metric="queue" onclick="toggleCheckbox('queue')">Очередники МИО</button>
                </div>
                <input type="range" min="0" max="1" step="0.1" value="0.3" oninput="changeLayerOpacity(this.value, 'queue')" title="Прозрачность">
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)"><i class="fa-solid fa-leaf"></i> 5. Экология</button>
        <div class="accordion-content"><div style="padding:10px; color:#777; font-size:11px;">Нет данных</div></div>
    </div>

    <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)"><i class="fa-solid fa-hand-holding-heart"></i> 6. Социальное развитие</button>
        <div class="accordion-content">
            <div class="layer-control-row">
                <div class="layer-control-left">
                    <input type="checkbox" onchange="toggleLayerVisibility(this, 'susn')">
                    <button class="layer-name-btn" data-metric="susn" onclick="toggleCheckbox('susn')">СУСН (Социально уязвимые)</button>
                </div>
                <input type="range" min="0" max="1" step="0.1" value="0.3" oninput="changeLayerOpacity(this.value, 'susn')" title="Прозрачность">
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)"><i class="fa-solid fa-landmark"></i> 7. Культура и туризм</button>
        <div class="accordion-content"><div style="padding:10px; color:#777; font-size:11px;">Нет данных</div></div>
    </div>
</div>

<div id="stats-panel">
    <div class="panel-header-row">
        <h4 id="region-title">РЕСПУБЛИКА КАЗАХСТАН</h4>
        <button class="expand-btn" onclick="toggleDashboard()" title="Развернуть"><i class="fa-solid fa-expand"></i></button>
    </div>
    <div class="chart-selector">
        <button id="btn-pop" class="active" onclick="switchChartMode('pop', this)">Население</button>
        <button id="btn-vvp" onclick="switchChartMode('vvp', this)">ВРП</button>
        <button id="btn-cpi" onclick="switchChartMode('cpi', this)">Расходы домох-в</button>
        <button id="btn-crime" onclick="switchChartMode('crime', this)">Преступность</button>
    </div>
    <div class="chart-container"><canvas id="mainChart"></canvas></div>
    <div class="panel-buttons">
        <a href="#" id="stat-link" class="action-btn btn-stat" target="_blank">Подробнее о регионе</a>
        <a href="#" id="map-link" class="action-btn btn-map">Перейти к карте</a>
    </div>
</div>

<div class="legend" id="legend"></div>
<div id="mapTransitionLoader"><img src="https://i.gifer.com/ZZ5H.gif" alt="Loading" style="width:50px;"><p>Загрузка...</p></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
// --- КОНФИГУРАЦИЯ ---
const regionLinks = {
    "г. Астана": "https://stat.gov.kz/ru/region/astana/", "г. Алматы": "https://stat.gov.kz/ru/region/almaty/", "г. Шымкент": "https://stat.gov.kz/ru/region/shymkent/",
    "Абайская область": "https://stat.gov.kz/ru/region/abay/", "Акмолинская область": "https://stat.gov.kz/ru/region/akmola/", "Актюбинская область": "https://stat.gov.kz/ru/region/aktobe/",
    "Алматинская область": "https://stat.gov.kz/ru/region/almaty-obl/", "Атырауская область": "https://stat.gov.kz/ru/region/atyrau/", "Восточно-Казахстанская область": "https://stat.gov.kz/ru/region/vko/",
    "Жамбылская область": "https://stat.gov.kz/ru/region/zhambyl/", "Жетысуская область": "https://stat.gov.kz/ru/region/zhetysu/", "Западно-Казахстанская область": "https://stat.gov.kz/ru/region/zko/",
    "Карагандинская область": "https://stat.gov.kz/ru/region/karaganda/", "Костанайская область": "https://stat.gov.kz/ru/region/kostanay/", "Кызылординская область": "https://stat.gov.kz/ru/region/kyzylorda/",
    "Мангистауская область": "https://stat.gov.kz/ru/region/mangystau/", "Павлодарская область": "https://stat.gov.kz/ru/region/pavlodar/", "Северо-Казахстанская область": "https://stat.gov.kz/ru/region/sko/",
    "Туркестанская область": "https://stat.gov.kz/ru/region/turkestan/", "Улытауская область": "https://stat.gov.kz/ru/region/ulytau/"
};

const externalMaps = {
    "Акмолинская область": "https://d05s4D1LBKwrkaccszeKOFu4-Xe7LDL-7BEiH.github.io/akmtrademapVa0HP07Ko/",
    "г. Костанай": "https://d05s4D1LBKwrkaccszeKOFu4-Xe7LDL-7BEiH.github.io/kostY5_JYrviDpanay/"
};

const nameMap = { 
    "АБАЙ": "Абайская область", "ОБЛАСТЬ АБАЙ": "Абайская область", 
    "ЖЕТІСУ": "Жетысуская область", "ОБЛАСТЬ ЖЕТІСУ": "Жетысуская область", 
    "УЛЫТАУ": "Улытауская область", "ОБЛАСТЬ ҰЛЫТАУ": "Улытауская область", 
    "ВОСТОЧНО-КАЗАХСТАНСКАЯ": "Восточно-Казахстанская область", "ЗАПАДНО-КАЗАХСТАНСКАЯ": "Западно-Казахстанская область", 
    "СЕВЕРО-КАЗАХСТАНСКАЯ": "Северо-Казахстанская область", "ЮЖНО-КАЗАХСТАНСКАЯ ОБЛАСТЬ": "Туркестанская область", 
    "АЛМАТЫ": "г. Алматы", "АСТАНА": "г. Астана", "ШЫМКЕНТ": "г. Шымкент", 
    "КОСТАНАЙСКАЯ Г.А.": "г. Костанай", 
    "РЕСПУБЛИКА КАЗАХСТАН": "РЕСПУБЛИКА КАЗАХСТАН" 
};

function safeFetch(url, fallbackValue = {type:'FeatureCollection',features:[]}) {
    return fetch(url)
        .then(r => { if(!r.ok) throw new Error(`HTTP error ${r.status}`); return r.json(); })
        .catch(e => { console.warn(`Failed to load ${url}:`, e); return fallbackValue; });
}

function escapeHtml(text) {
    if (text == null) return '';
    return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

function toTitleCase(str) {
    if (!str) return '';
    return str.toLowerCase().replace(/(?:^|\s|-)\S/g, function(a) { return a.toUpperCase(); });
}

function getStandardName(rawName) {
    if (!rawName) return "";
    let n = rawName.replace(/['"]+/g, '').trim();
    let up = n.toUpperCase();
    if (nameMap[up]) return nameMap[up];
    for (let key in regionLinks) {
        if (key.toUpperCase() === up) return key;
    }
    return toTitleCase(n);
}

function formatNum(n) { 
    if(n === undefined || n === null) return '0'; 
    if(n>=1e9) return (n/1e9).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})+' млрд'; 
    if(n>=1e6) return (n/1e6).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2})+' млн'; 
    if(n>=1e3) return (n/1e3).toLocaleString('ru-RU', {minimumFractionDigits: 1, maximumFractionDigits: 1})+' тыс'; 
    return Number(n).toLocaleString('ru-RU'); 
}

let currentZoomMode = 'republic'; 
// По умолчанию currentMetric пустая, чтобы карта была "выключена"
let currentMetric = null; 
let currentRegion = "РЕСПУБЛИКА КАЗАХСТАН";
let chartMode = "pop"; 
let myChart = null;
let lastHighlighted = null;
const db = { pop: [], crime: [], vvp: [], potreb: [] };

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    manualSwitchLevel('republic');
});

const metricsConfig = {
    retail: { field: 'Розничная торговля – продовольственные товары', title: 'Розничная торговля', colors: ['#fff7bc','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02'], breaks: [1e6, 5e6, 15e6, 30e6, 60e6] },
    wholesale: { field: 'Оптовая торговля – продовольственные товары', title: 'Оптовая торговля', colors: ['#e0f3db','#ccebc5','#a8ddb5','#7bccc4','#4eb3d3','#2b8cbe'], breaks: [1e6, 10e6, 50e6, 100e6, 200e6] },
    population: { field: 'Численность населения', title: 'Население', colors: ['#f2f0f7','#dadaeb','#bcbddc','#9e9ac8','#756bb1','#54278f'], breaks: [15000, 30000, 50000, 100000, 200000] },
    crime: { field: 'crime_rate', title: 'Преступность', colors: ['#fee5d9','#fcbba1','#fc9272','#fb6a4a','#de2d26','#a50f15'], breaks: [100, 500, 1000, 2000, 5000] },
    vvp: { field: 'vrp', title: 'ВРП на душу', colors: ['#edf8e9','#c7e9c0','#a1d99b','#74c476','#31a354','#006d2c'], breaks: [2000, 3200, 5800, 10500] },
    queue: { field: 'estate_demand', title: 'Очередники', colors: ['#f2f0f7','#dadaeb','#bcbddc','#9e9ac8','#756bb1'], breaks: [20000, 26000, 32000, 45000] },
    susn: { field: 'СУСН (человек)', title: 'СУСН (люди)', colors: ['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15'], breaks: [655, 1883, 3899, 6950, 12263] },
    balance: { field: null, title: 'Баланс', colors: [], breaks: [] }
};

let map, oblastLayer, bordersLayer, districtsLayer, townsLayer, okrugaLayer, storagesLayer, fairsLayer, kazBorderLayer, districtsBorderLayer;
let layerOpacities = { population: 0.7, crime: 0.7, vvp: 0.7, retail: 0.7, wholesale: 0.7, balance: 0.7, queue: 0.7, susn: 0.7 };
// ВСЕ ВЫКЛЮЧЕНО ПО УМОЛЧАНИЮ
let layerVisibility = { population: false, crime: false, vvp: false, retail: false, wholesale: false, balance: false, queue: false, susn: false };

function getColor(val, metric) {
    if(metric === 'balance') return '#e0e0e0';
    const conf = metricsConfig[metric];
    if(!conf || !conf.colors) return '#eee';
    for(let i=0; i<conf.breaks.length; i++) if(val < conf.breaks[i]) return conf.colors[i];
    return conf.colors[conf.colors.length-1];
}

function getUniversalStyle(f, level) {
    // Если метрика не выбрана или чекбокс выключен -> показываем только границы (прозрачная заливка)
    if (!currentMetric || !layerVisibility[currentMetric]) {
        return { fillColor: '#fff', fillOpacity: 0, color: '#444', weight: (level==='okrug'?0.5:1), opacity: 0.5 };
    }

    let val = 0;
    if (currentMetric === 'vvp') {
        val = f.properties['vrp'] || f.properties['vvp_val'] || f.properties['vrp_per_capita'] || f.properties['ВРП'] || 0;
    } else if (currentMetric === 'susn') {
        val = f.properties['СУСН (человек)'] || 0;
    } else {
        const field = metricsConfig[currentMetric]?.field;
        if (field && f.properties[field] !== undefined) val = f.properties[field];
    }

    let fillColor = '#eee';
    if (currentMetric === 'balance' && (level === 'oblast' || level === 'republic')) fillColor = '#e0e0e0';
    else if (val > 0) fillColor = getColor(val, currentMetric);
    
    // ПРОЗРАЧНОСТЬ
    // slider 0 => opacity 1 (solid)
    // slider 1 => opacity 0 (invisible)
    let opacityVal = 1 - (layerOpacities[currentMetric] || 0);
    // Защита от полного исчезновения, если нужно, или оставить как есть
    if (opacityVal < 0) opacityVal = 0;
    if (opacityVal > 1) opacityVal = 1;
    
    let w = 1, col = '#444';
    if (level === 'np') { w=1; col='#333'; }
    if (level === 'okrug') { w=0.6; col='#666'; }
    if (level === 'rayon') { w=0.8; col='#666'; }
    if (level === 'oblast' || level === 'republic') { w=1; col='white'; }

    return { fillColor: fillColor, color: col, weight: w, fillOpacity: opacityVal, opacity: 1 };
}

function getEntityName(f, level) {
    const p = f.properties;
    if(level === 'oblast' || level === 'republic') return toTitleCase(p.ADM_1_RUS || p.ADM1_EN || 'Область');
    if(level === 'rayon') {
        let name = p.ADM_2_rus || p.ADM2_EN || 'Район';
        name = name.replace(/район/gi, '').trim();
        return 'Район ' + toTitleCase(name);
    }
    if(level === 'okrug') return toTitleCase(p.okrug || p.NAME || 'Округ');
    if(level === 'np') return toTitleCase(p['name:ru'] || p.name || 'НП');
    return 'Объект';
}

function handleMapClick(e, feature) {
    L.DomEvent.stopPropagation(e);
    highlightFeature(e);
    const p = feature.properties;
    const bestRegionName = p.ADM_1_RUS || p.ADM1_EN || p.NAME || ''; 
    if (bestRegionName) {
        currentRegion = getStandardName(bestRegionName);
        updateChart();
    }
}

function getLatestPopulation(regionName) {
    if (!db.pop || !db.pop.length) return 0;
    const stdName = getStandardName(regionName);
    const item = db.pop.find(d => getStandardName(d.termNames[0]) === stdName && 
                                  d.termNames.some(t => String(t).toLowerCase().includes("все") || String(t).toLowerCase() === "total"));
    if (!item || !item.periods) return 0;
    const sorted = item.periods.sort((a,b) => parseDate(b.date) - parseDate(a.date));
    if (sorted.length > 0) return parseFloat(sorted[0].value);
    return 0;
}

map = L.map('map', { center: [48.0, 66.0], zoom: 5, zoomControl: false });
L.control.zoom({ position: 'topright' }).addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

Promise.all([
    safeFetch('balance.geojson', {type:'FeatureCollection',features:[]}),
    safeFetch('oblborders.geojson', {type:'FeatureCollection',features:[]}),
    safeFetch('districts.geojson', {type:'FeatureCollection',features:[]}),
    safeFetch('okruga.geojson', {type:'FeatureCollection',features:[]}),
    safeFetch('towns.geojson', {type:'FeatureCollection',features:[]}),
    safeFetch('storages.geojson', {type:'FeatureCollection',features:[]}),
    safeFetch('fairs.geojson', {type:'FeatureCollection',features:[]}),
    safeFetch('kazborder.geojson', {type:'FeatureCollection',features:[]}),
    safeFetch('districtsborder.geojson', {type:'FeatureCollection',features:[]}), // ГРАНИЦЫ РАЙОНОВ
    safeFetch('703831.json', []), 
    safeFetch('704767-kolichestvo-prestupleniy.json', []),
    safeFetch('2709379-vvp-metodom-proizvodstva.json', []), 
    safeFetch('potreb-rashody.json', [])
]).then(([oblG, bordG, distG, okrG, twnG, storeG, fairG, kazG, distBorderG, popD, criD, vvpD, potrebD]) => {
    db.pop = popD; db.crime = criD; db.vvp = vvpD; db.potreb = potrebD;

    // ГРАНИЦА КЗ (ТОНКАЯ, СВЕРХУ)
    kazBorderLayer = L.geoJSON(kazG, {
        style: { color: '#000', weight: 1.0, fill: false, opacity: 1 },
        interactive: false,
        pane: 'overlayPane'
    }).addTo(map);

    // ГРАНИЦЫ РАЙОНОВ (ЛИНЕЙНЫЙ СЛОЙ, ДЛЯ УРОВНЯ "РАЙОН")
    districtsBorderLayer = L.geoJSON(distBorderG, {
        style: { color: '#333', weight: 1.2, fill: false, opacity: 0.8 },
        interactive: false,
        pane: 'overlayPane'
    });

    oblastLayer = L.geoJSON(oblG, {
        style: (f) => getUniversalStyle(f, 'oblast'),
        onEachFeature: (f,l) => {
            l.on('click', e => { 
                handleMapClick(e, f);
                const content = getUniversalPopup(f, 'oblast');
                l.bindPopup(content, {maxWidth:420}).openPopup();
            });
        }
    });

    districtsLayer = L.geoJSON(distG, {
        style: (f) => getUniversalStyle(f, 'rayon'),
        onEachFeature: (f,l) => {
            l.on('click', e => { 
                handleMapClick(e, f);
                const content = getUniversalPopup(f, 'rayon');
                l.bindPopup(content, {maxWidth:400}).openPopup();
            });
        }
    });

    okrugaLayer = L.geoJSON(okrG, { 
        style: (f) => getUniversalStyle(f, 'okrug'), 
        onEachFeature:(f,l)=> {
            l.on('click', e => { 
                handleMapClick(e, f);
                const content = getUniversalPopup(f, 'okrug');
                l.bindPopup(content, {maxWidth:350}).openPopup();
            });
        } 
    });
    
    // ИКОНКИ ГОРОДОВ
    townsLayer = L.geoJSON(twnG, { 
        pointToLayer: (f, latlng) => {
            let pop = f.properties.popul || 1000;
            let size = Math.min(Math.max(pop / 5000, 12), 30);
            return L.marker(latlng, {
                icon: L.icon({
                    iconUrl: 'location-pin.png', 
                    iconSize: [size, size],
                    iconAnchor: [size/2, size],
                    popupAnchor: [0, -size]
                })
            });
        },
        onEachFeature:(f,l)=> {
            l.on('click', e => { 
                handleMapClick(e, f);
                const content = getUniversalPopup(f, 'np');
                l.bindPopup(content, {maxWidth:300}).openPopup();
            });
        }
    });

    bordersLayer = L.geoJSON(bordG, { style:{color:'#888', weight:1.5, dashArray:'4, 4', fill:false}, interactive:false, pane:'overlayPane' }).addTo(map);

    const storeIcon = L.icon({iconUrl:'warehouse.png', iconSize:[18,18], iconAnchor:[9,18], popupAnchor:[0,-14]});
    const fairIcon = L.icon({iconUrl:'stall.png', iconSize:[18,18], iconAnchor:[9,18], popupAnchor:[0,-14]});
    
    storagesLayer = L.geoJSON(storeG, { 
        pointToLayer:(f,ll)=>L.marker(ll,{icon:storeIcon}), 
        onEachFeature:(f,l)=> {
            const p = f.properties;
            const content = `<div class="popup-header">${escapeHtml(p['Наименование компании владельца']||'Склад')}</div><div class="popup-body">Адрес: ${escapeHtml(p['Адрес']||'-')}</div>`;
            l.bindPopup(content);
        }
    });
    
    fairsLayer = L.geoJSON(fairG, { 
        pointToLayer:(f,ll)=>L.marker(ll,{icon:fairIcon}), 
        onEachFeature:(f,l)=>l.bindPopup(`<div class="popup-header" style="background:green">${escapeHtml(f.properties['Название']||'Ярмарка')}</div>`) 
    });

    updateMapState(); updateChart(); updateLegend();

    document.getElementById('storageToggle').addEventListener('change', e => e.target.checked ? map.addLayer(storagesLayer) : map.removeLayer(storagesLayer));
    document.getElementById('fairsToggle').addEventListener('change', e => e.target.checked ? map.addLayer(fairsLayer) : map.removeLayer(fairsLayer));
    document.getElementById('map-link').addEventListener('click', function(e) {
        e.preventDefault();
        const href = this.getAttribute('href');
        if (href && href !== '#') {
            document.getElementById('mapTransitionLoader').style.display = 'flex';
            setTimeout(() => { window.location.href = href; }, 500);
        }
    });

}).catch(e => console.error("Global Init Error:", e));

// --- ЛОГИКА ---
function highlightFeature(e) {
    const layer = e.target;
    // Если это маркер (город/склад), у него нет setStyle, пропускаем подсветку
    if (!layer.setStyle) return;

    if (lastHighlighted && lastHighlighted.setStyle) {
        let level = 'oblast';
        if (currentZoomMode === 'republic') level = 'oblast';
        else if (currentZoomMode === 'oblast') level = 'rayon';
        else if (currentZoomMode === 'district') level = 'okrug';
        else if (currentZoomMode === 'town') level = 'np';
        
        let style = getUniversalStyle(lastHighlighted.feature, level);
        lastHighlighted.setStyle(style);
    }
    
    // ВАЖНОЕ ИСПРАВЛЕНИЕ: ТОЛЬКО ОБВОДКА, БЕЗ ЗАЛИВКИ
    layer.setStyle({ color: '#008b8b', weight: 3, fillOpacity: 0 });
    layer.bringToFront();
    
    if(bordersLayer) bordersLayer.bringToFront();
    if(kazBorderLayer) kazBorderLayer.bringToFront();
    if(districtsBorderLayer && map.hasLayer(districtsBorderLayer)) districtsBorderLayer.bringToFront();
    
    lastHighlighted = layer;
}

function toggleAccordion(btn) {
    const item = btn.parentElement;
    const wasActive = item.classList.contains('active');
    document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('active'));
    if(!wasActive) item.classList.add('active');
}

function toggleDashboard() {
    const p = document.getElementById('stats-panel');
    p.classList.toggle('expanded');
    if(myChart) setTimeout(()=>myChart.resize(), 300);
}

// Упрощенная функция для клика по названию (тот же функционал, что и чекбокс)
function toggleCheckbox(metric) {
    const chk = document.querySelector(`input[type="checkbox"][onchange*="${metric}"]`);
    if (chk) {
        chk.checked = !chk.checked;
        toggleLayerVisibility(chk, metric);
    }
}

// Мы не используем старый setLayer напрямую, теперь все через toggle
function setLayer(metric, btn) {
    // Эта функция осталась для совместимости, но лучше использовать toggleLayerVisibility
    // Принудительно включаем чекбокс
    const chk = btn.previousElementSibling;
    if (chk) {
        chk.checked = true;
        toggleLayerVisibility(chk, metric);
    }
}

function toggleLayerVisibility(checkbox, metric) {
    layerVisibility[metric] = checkbox.checked;
    
    // Если мы включили слой - делаем его активным для раскраски
    if (checkbox.checked) {
        currentMetric = metric;
        // Подсвечиваем текст
        document.querySelectorAll('.layer-name-btn').forEach(b => b.classList.remove('active'));
        const btn = checkbox.nextElementSibling;
        if(btn) btn.classList.add('active');
    } else {
        // Если выключили текущий активный слой
        if (currentMetric === metric) {
            // Ищем, есть ли другие включенные слои
            const otherActive = Object.keys(layerVisibility).reverse().find(k => layerVisibility[k]);
            if (otherActive) {
                currentMetric = otherActive; // Переключаемся на другой включенный
                // Обновляем UI текста
                document.querySelectorAll('.layer-name-btn').forEach(b => b.classList.remove('active'));
                const btn = document.querySelector(`.layer-name-btn[data-metric="${otherActive}"]`);
                if(btn) btn.classList.add('active');
            } else {
                currentMetric = null; // Все выключено
                document.querySelectorAll('.layer-name-btn').forEach(b => b.classList.remove('active'));
            }
        }
    }
    
    redrawLayers();
    updateLegend();
}

function changeLayerOpacity(val, metric) {
    layerOpacities[metric] = parseFloat(val);
    // Перерисовываем карту, даже если метрика не активна (на случай если мы переключимся на нее)
    // Но главное - если это ТЕКУЩАЯ метрика, карта обновится сразу
    redrawLayers(); 
}

function redrawLayers() {
    if(oblastLayer) oblastLayer.setStyle(f => getUniversalStyle(f, 'oblast'));
    if(districtsLayer) districtsLayer.setStyle(f => getUniversalStyle(f, 'rayon'));
    if(okrugaLayer) okrugaLayer.setStyle(f => getUniversalStyle(f, 'okrug'));
}

function manualSwitchLevel(mode) {
    currentZoomMode = mode;
    document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
    
    let btnId = '';
    if(mode === 'republic') btnId = 'btn-lvl-republic';
    if(mode === 'oblast') btnId = 'btn-lvl-oblast';
    if(mode === 'district') btnId = 'btn-lvl-district';
    if(mode === 'town') btnId = 'btn-lvl-town';
    
    const btn = document.getElementById(btnId);
    if(btn) btn.classList.add('active');
    
    updateMapState();
}

function updateMapState() {
    [oblastLayer, districtsLayer, okrugaLayer, townsLayer].forEach(l => { if(l && map.hasLayer(l)) map.removeLayer(l); });
    
    // Включаем нужный слой в зависимости от режима (Zoom In логика)
    if (currentZoomMode === 'republic' && oblastLayer) map.addLayer(oblastLayer);
    else if (currentZoomMode === 'oblast' && districtsLayer) map.addLayer(districtsLayer);
    else if (currentZoomMode === 'district' && okrugaLayer) map.addLayer(okrugaLayer);
    else if (currentZoomMode === 'town' && townsLayer) map.addLayer(townsLayer);
    
    // Управление доп. слоями
    if (districtsBorderLayer) {
        if (currentZoomMode === 'district') {
            map.addLayer(districtsBorderLayer);
            districtsBorderLayer.bringToFront();
        } else {
            if (map.hasLayer(districtsBorderLayer)) map.removeLayer(districtsBorderLayer);
        }
    }

    if (bordersLayer && currentZoomMode !== 'town') bordersLayer.bringToFront();
    if (kazBorderLayer) kazBorderLayer.bringToFront();
}

function updateLegend() {
    const el = document.getElementById('legend');
    
    if (!currentMetric || !layerVisibility[currentMetric]) {
        el.innerHTML = '';
        return;
    }

    if(currentMetric === 'balance') { el.innerHTML='<b>Баланс</b><br>Кликните на регион'; return; }
    const c = metricsConfig[currentMetric];
    if(!c || !c.colors) { el.innerHTML=''; return; }
    
    let unit = (currentMetric === 'vvp') ? ' (тыс. ₸)' : '';
    let h = `<div class="legend-title">${c.title}${unit}</div>`;
    
    c.colors.forEach((col, i) => {
        let label;
        if (i === 0) label = '< ' + formatNum(c.breaks[0]);
        else if (i === c.colors.length - 1) label = '> ' + formatNum(c.breaks[c.breaks.length - 1]);
        else label = formatNum(c.breaks[i-1]) + ' – ' + formatNum(c.breaks[i]);
        h += `<div class="legend-item"><div class="legend-color" style="background:${col}"></div>${label}</div>`;
    });
    el.innerHTML = h;
}

// --- ГРАФИКИ ---
function parseDate(str) {
    try {
        if (!str) return new Date(0);
        if(str.includes('.')) { const p = str.split('.'); if(p.length === 3) return new Date(p[2], p[1]-1, p[0]); }
        let m={январь:0,февраль:1,март:2,апрель:3,май:4,июнь:5,июль:6,август:7,сентябрь:8,октябрь:9,ноябрь:10,декабрь:11};
        let parts=str.toLowerCase().replace(' г.','').trim().split(' '); 
        if(parts.length >= 2) { return new Date(parseInt(parts[1]), m[parts[0]]||0, 1); }
        return new Date(0);
    } catch(e) { return new Date(0); }
}

function switchChartMode(m, btn) { 
    chartMode = m; document.querySelectorAll('.chart-selector button').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); updateChart(); 
}

function updateChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    if(myChart) { myChart.destroy(); myChart = null; }
    
    const linkBtn = document.getElementById('stat-link');
    const mapBtn = document.getElementById('map-link');
    
    document.getElementById('region-title').innerText = currentRegion;
    
    const url = regionLinks[currentRegion];
    if (url) { linkBtn.href = url; linkBtn.style.display = 'block'; } else { linkBtn.style.display = 'none'; }
    
    const mapUrl = externalMaps[currentRegion];
    if (mapUrl) { mapBtn.href = mapUrl; mapBtn.style.display = 'block'; } else { mapBtn.style.display = 'none'; }

    let labels=[], datasets=[], type='line';
    const safeParse = (val) => { const v = parseFloat(val); return isNaN(v) ? 0 : v; };

    if(chartMode==='pop'){
        if (db.pop && db.pop.length) {
            const item = db.pop.find(d => getStandardName(d.termNames[0])===currentRegion && d.termNames.some(t=>String(t).toLowerCase().includes("все")||String(t).toLowerCase()==="total"));
            if(item){ const s=item.periods.sort((a,b)=>parseDate(a.date)-parseDate(b.date)); labels=s.map(p=>p.name.replace(' год','')); datasets.push({label:"Численность", data:s.map(p=>safeParse(p.value)), borderColor:"#3498db", tension:0.3, fill:false}); }
        }
    } 
    else if(chartMode==='crime'){
        if (db.crime && db.crime.length) {
            const item = db.crime.find(d => getStandardName(d.termNames[0])===currentRegion);
            if(item){ const s=item.periods.filter(p=>p.name.includes('Декабрь')).sort((a,b)=>parseDate(a.date)-parseDate(b.date)); labels=s.map(p=>p.date.split('.')[2]); datasets.push({label:"Преступления", data:s.map(p=>safeParse(p.value)), borderColor:"#c0392b", tension:0.3, fill:false}); }
        }
    } 
    else if(chartMode==='vvp'){
        type='bar';
        if (db.vvp && db.vvp.length) {
            const item = db.vvp.find(d => getStandardName(d.termNames[0])===currentRegion);
            if(item){ const s=item.periods.sort((a,b)=>parseDate(a.date)-parseDate(b.date)); labels=s.map(p=>p.name.replace(' год','')); datasets.push({label:"ВРП (млрд)", data:s.map(p=>safeParse(p.value)/1e9), backgroundColor:"#27ae60"}); }
        }
    } 
    else if(chartMode==='cpi'){
        if (db.potreb && db.potreb.length) {
            const urban = db.potreb.find(d => getStandardName(d.termNames[0])===currentRegion && d.termNames.some(t=>t.toLowerCase().includes('городская')));
            const rural = db.potreb.find(d => getStandardName(d.termNames[0])===currentRegion && d.termNames.some(t=>t.toLowerCase().includes('сельская')));
            if (urban || rural) {
                const periods = (urban || rural).periods.sort((a,b)=>parseDate(a.date)-parseDate(b.date));
                labels = periods.map(p=>p.name.replace(' год',''));
                if(urban) datasets.push({label:'Город', data:urban.periods.sort((a,b)=>parseDate(a.date)-parseDate(b.date)).map(p=>safeParse(p.value)/12), borderColor:'#e67e22', tension:0.3});
                if(rural) datasets.push({label:'Село', data:rural.periods.sort((a,b)=>parseDate(a.date)-parseDate(b.date)).map(p=>safeParse(p.value)/12), borderColor:'#27ae60', tension:0.3});
            }
        }
    }

    if(!datasets.length) { 
        myChart = new Chart(ctx,{type:'bar',data:{labels:["Нет данных"],datasets:[{label:"Нет данных",data:[0]}]}}); 
        return; 
    }
    myChart = new Chart(ctx, { type: type, data: { labels: labels, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: chartMode!=='cpi' }, x: { ticks: { font: { size: 9 } } } }, plugins: { legend: { display: true, labels:{boxWidth:10} } } } });
}

// --- УНИВЕРСАЛЬНЫЙ ПОПАП ---
function getUniversalPopup(f, level) {
    const p = f.properties;
    const name = getEntityName(f, level);
    
    let subtitle = '';
    // Исправление ошибки 2: используем новые имена уровней
    if (level === 'rayon') subtitle = toTitleCase(p.ADM1_EN || p.ADM_1_RUS || '');
    if (level === 'okrug') subtitle = toTitleCase(p.ADM_2_rus || p.RAION || '');
    const header = `<div class="popup-header">${escapeHtml(name)}${subtitle ? `<span class="popup-sub">${escapeHtml(subtitle)}</span>` : ''}</div>`;

    let footer = '';
    // Исправление ошибки 2: level === 'np' для городов
    // Улучшенная проверка на Костанай (вхождение подстроки)
    if (level === 'np' && name.toUpperCase().includes('КОСТАНАЙ')) {
        footer = `<a href="https://d05s4D1LBKwrkaccszeKOFu4-Xe7LDL-7BEiH.github.io/kostY5_JYrviDpanay/" target="_blank" class="popup-btn-link">Перейти к карте Костаная</a>`;
    }
    
    // 1. БАЛАНС
    if (currentMetric === 'balance') {
        const products = ["Лук репчатый", "Картофель", "Морковь", "Капуста белокочанная", "Сахар-песок", "Масло подсолнечное", "Масло сливочное несоленое", "Молоко пастеризованное", "Творог 5-9% жирности", "Говядина с костями", "Рожки", "Мука пшеничная первого сорта", "Рис шлифованный, полированный", "Яйца, 1 категории", "Соль, кроме экстра"];
        const half = Math.ceil(products.length / 2);
        const leftProducts = products.slice(0, half);
        const rightProducts = products.slice(half);

        function generateProductHtml(prodKey) {
            const val = p[prodKey];
            if (!val || val.trim() === '') return '';
            const match = val.match(/^(.*?)\s*\((\d+(?:[.,]\d+)?)\)$/);
            let region = val;
            let percentStr = '';
            let colorClass = '';
            if (match) {
                region = match[1].trim();
                const percent = parseFloat(match[2].replace(',', '.'));
                if (!isNaN(percent)) {
                    percentStr = 'Наценка: ' + percent.toFixed(1).replace('.', ',') + '%';
                    if (percent > 30) colorClass = 'markup-red';
                    else if (percent >= 15) colorClass = 'markup-yellow';
                    else colorClass = 'markup-green';
                }
            }
            return `<div class="balance-flow-item"><span class="bal-prod">${escapeHtml(prodKey)}:</span><span class="bal-region">${escapeHtml(region)}</span>${percentStr ? `<span class="bal-markup ${colorClass}">${percentStr}</span>` : ''}</div>`;
        }
        return `${header}<div class="popup-body"><div class="balance-grid"><div class="balance-col">${leftProducts.map(generateProductHtml).join('')}</div><div class="balance-col">${rightProducts.map(generateProductHtml).join('')}</div></div>${footer}</div>`;
    }

    // 2. СУСН
    if (currentMetric === 'susn') {
        const susnFam = p['СУСН (семей)'] || 0;
        const susnPers = p['СУСН (человек)'] || 0;
        const pop = p['Численность населения'] || 0;
        return `${header}<div class="popup-body"><div class="popup-row"><span class="popup-label">Общее население:</span><span class="popup-value">${formatNum(pop)}</span></div><div class="popup-row"><span class="popup-label">СУСН (семей):</span><span class="popup-value">${formatNum(susnFam)}</span></div><div class="popup-row"><span class="popup-label">СУСН (чел):</span><span class="popup-value">${formatNum(susnPers)}</span></div>${footer}</div>`;
    }

    // 3. ОЧЕРЕДНИКИ
    if (currentMetric === 'queue') {
        const d = p['estate_demand'] || 0; 
        const r = p['estate_recieved'] || 0;
        let pop = getLatestPopulation(name);
        if (pop === 0) pop = p['Численность населения'] || 0;
        return `${header}<div class="popup-body"><div class="popup-row"><span class="popup-label">Население:</span><span class="popup-value">${formatNum(pop)}</span></div><div class="popup-row"><span class="popup-label">Очередники:</span><span class="popup-value">${formatNum(d)}</span></div><div class="popup-row"><span class="popup-label">Получили жилье:</span><span class="popup-value">${formatNum(r)}</span></div>${footer}</div>`;
    }

    // 4. ВРП ИЛИ НАСЕЛЕНИЕ (ОБЩАЯ ЛОГИКА ДЛЯ ПОПАПА)
    if (currentMetric === 'vvp' || currentMetric === 'population') {
        let pop = getLatestPopulation(name);
        if (pop === 0) pop = p['Численность населения'] || 1;
        
        let extraRow = '';
        if (currentMetric === 'vvp') {
            const perCapitaVal = p['vrp'] || p['vvp_val'] || p['vrp_per_capita'] || p['ВРП'] || 0; 
            const formatted = Number(perCapitaVal).toLocaleString('ru-RU');
            extraRow = `<div class="popup-row"><span class="popup-label">ВРП на душу:</span><span class="popup-value">${formatted} тыс. ₸</span></div>`;
        }

        return `${header}<div class="popup-body"><div class="popup-row"><span class="popup-label">Население:</span><span class="popup-value">${formatNum(pop)}</span></div>${extraRow}${footer}</div>`;
    }
    
    // 6. ТОРГОВЛЯ (ДЕФОЛТ)
    const ret = p['Розничная торговля – продовольственные товары']||0;
    const whole = p['Оптовая торговля – продовольственные товары']||0;
    const pop = p['Численность населения']||0;
    return `${header}<div class="popup-body"><div class="popup-row"><span class="popup-label">Розница:</span><span class="popup-value">${formatNum(ret)}</span></div><div class="popup-row"><span class="popup-label">Опт:</span><span class="popup-value">${formatNum(whole)}</span></div><div class="popup-row"><span class="popup-label">Население:</span><span class="popup-value">${formatNum(pop)}</span></div>${footer}</div>`;
}
</script>
</body>
</html>