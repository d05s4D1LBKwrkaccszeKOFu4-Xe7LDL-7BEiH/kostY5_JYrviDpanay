<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Костанай – Аналитическая карта</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" />

<style>
    html,body{margin:0;padding:0;height:100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
    #map{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;background:#f8f9fa}
    
    /* --- Кнопки справа --- */
    .external-link-btn {
        position: absolute; top: 20px; right: 20px; z-index: 1000;
        background: #ffffff; padding: 10px 16px; border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-decoration: none;
        color: #1e293b; font-size: 13px; font-weight: 700; border: 1px solid #e2e8f0;
        transition: all 0.2s; display: flex; align-items: center; gap: 8px;
    }
    .external-link-btn:hover { background: #f8fafc; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); color: #2563eb; }

    /* Переключатель подложки */
    .basemap-switcher {
        position: absolute; top: 70px; right: 20px; z-index: 1000;
        background: white; padding: 4px; border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; gap: 4px;
        border: 1px solid #e2e8f0;
    }
    .basemap-btn {
        border: none; background: transparent; padding: 6px 12px;
        border-radius: 6px; font-size: 12px; font-weight: 600; color: #64748b;
        cursor: pointer; transition: all 0.2s;
    }
    .basemap-btn:hover { background: #f1f5f9; color: #333; }
    .basemap-btn.active { background: #eff6ff; color: #2563eb; font-weight: 700; box-shadow: inset 0 0 0 1px #bfdbfe; }

/* Адаптированные стили аккордеона из style.css */

.metrics-control-left {
    position: absolute; top: 20px; left: 20px;  /* Сохранили из вашего HTML */
    width: 250px; /* Сохранили вашу ширину, вместо 320px из css */
    max-height: calc(100vh - 280px);  /* Из css, адаптировали под ваш max-height */
    display: flex; flex-direction: column; z-index: 1000; /* Сохранили ваш z-index */
    background: rgba(255, 255, 255, 0.98); /* Сохранили ваш фон */
    border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); /* Сохранили ваши стили */
    overflow-y: auto; overflow-x: hidden; /* Из css */
    padding: 0; /* Из css */
    backdrop-filter: blur(10px); /* Сохранили ваш */
}

details {  /* Замена .acc-item */
    border-bottom: 1px solid #eee;  /* Из css */
}

summary {  /* Замена .acc-header */
    padding: 12px 15px; cursor: pointer; font-size: 13px; font-weight: 700; color: #2c3e50;  /* Из css */
    display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;  /* Из css */
}

summary:hover { background: #f8f9fa; }  /* Из css (замена .acc-header:hover) */

summary::after {  /* Замена .acc-header::after */
    content: '›'; font-size: 16px; color: #999; transform: rotate(90deg); transition: transform 0.3s;  /* Из css */
}

details[open] summary::after {  /* Замена .acc-item.active .acc-header::after */
    transform: rotate(-90deg);  /* Из css */
}

.metrics-group {  /* Замена .acc-body */
    display: none; padding: 5px 0; background: #fff;  /* Из css */
}

details[open] .metrics-group {  /* Замена .acc-item.active .acc-body */
    display: block;  /* Из css */
}

/* Кнопки метрик (адаптация .metric-option из css к .metric-btn) */
.metric-btn {
    display: flex; align-items: center; width: 100%; text-align: left;  /* Из css */
    padding: 10px 15px; border: none; background: transparent;  /* Из css */
    cursor: pointer; font-size: 13px; color: #555; box-sizing: border-box;  /* Из css */
}

.metric-btn:hover { background: #f0f2f5; }  /* Из css (замена .metric-option:hover) */

.metric-btn.active { background: #e7f5ff; color: #0066cc; font-weight: 600; border-right: 3px solid #0066cc; }  /* Из css */

    /* Описание */
    .description-panel {
        position: absolute; bottom: 30px; left: 20px; width: 400px;
        background: rgba(255, 255, 255, 0.98); padding: 12px 15px; border-radius: 12px;
        box-shadow: 0 4px 25px rgba(0,0,0,0.15); z-index: 999; 
        font-size: 12px; border-left: 4px solid #3b82f6; display: none;
    }

    .desc-header {
        display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }

    #descText {
        margin-top: 10px; display: none;
        border-top: 1px solid #f1f5f9; padding-top: 8px; color: #64748b;
    }

    .toggle-icon {
        font-size: 12px; font-weight: bold; color: #3b82f6; transition: transform 0.3s;
    }
    .toggle-icon.active { transform: rotate(180deg); }

    /* Панель маршрутов */
    #routes-panel {
        display: none; flex-wrap: wrap; gap: 4px; margin-top: 5px; padding: 5px;
        background: #f8fafc; border-radius: 6px; border: 1px solid #f1f5f9;
    }
    .route-select-btn {
        padding: 4px 8px; font-size: 11px; font-weight: 600; border: 1px solid #e2e8f0;
        background: white; color: #64748b; border-radius: 4px; cursor: pointer; flex: 1 0 auto; text-align: center;
    }
    .route-select-btn.active { background: #3b82f6; color: white; border-color: #2563eb; }

    /* Панель диаграмм */
    .chart-panel {
        position: absolute; top: 110px; right: 20px;
        background: white; padding: 15px; border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1); z-index: 1000;
        width: 260px; display: none;
        transition: none !important; animation: none !important;
    }
    .chart-panel h4 { margin: 0 0 10px 0; font-size: 13px; color: #333; text-align: center; font-weight: 700;}
.chart-container { 
    position: relative; 
    height: 130px; /* Было 200px — это приподнимет всё, что ниже, выше */
    width: 100%; 
}

/* --- Стили для кнопок горячих точек --- */
#crimeHotspotsPanel {
    margin-top: 5px; /* Было 15px — уменьшаем до 5px */
    padding-top: 5px; /* Было 10px — уменьшаем до 5px */
    border-top: 1px solid #f1f5f9;
    display: none;
}
    
    .hotspot-buttons-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
    }

    .hotspot-btn {
        flex: 1 1 45%; /* Кнопки занимают ~половину ширины */
        padding: 6px 8px;
        font-size: 11px;
        font-weight: 600;
        color: #64748b;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
    }

    .hotspot-btn:hover {
        background: #fee2e2;
        color: #991b1b;
        border-color: #fecaca;
    }

    .hotspot-btn.active {
        background: #ef4444;
        color: white;
        border-color: #b91c1c;
    }

    #hotspotTextBox {
        background: #fdf2f8; /* Светло-розовый фон для акцента */
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #fbcfe8;
        font-size: 12px;
        color: #831843;
        line-height: 1.4;
        min-height: 40px;
    }

    /* Легенда */
    .legend{
        position:absolute; bottom:30px; right:20px; background:white; padding:15px; border-radius:12px;
        box-shadow:0 4px 20px rgba(0,0,0,.1); font-size:12px; width:220px; z-index:999;
    }
    .legend-title{ margin-bottom:12px; font-size:13px; color:#1e293b; font-weight: 700; }
    
    #slider-container { margin-top: 25px; margin-bottom: 10px; padding: 0 5px; }
    .noUi-connect { background: #3b82f6; }
    .noUi-handle { height: 18px; width: 18px; top: -7px; right: -9px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: grab;}
    .legend-labels { display: flex; justify-content: space-between; margin-top: 5px; color: #64748b; font-size: 10px; }
    .legend-item { display: flex; align-items: center; gap: 10px; margin: 6px 0; }
    .legend-color { width: 16px; height: 16px; border-radius: 4px; }

    /* Попапы */
    .leaflet-popup-content-wrapper { 
        border-radius:10px !important; box-shadow:0 15px 40px rgba(0,0,0,0.25)!important; 
        padding: 0 !important; overflow: hidden; 
    }
    .leaflet-popup-content { 
        margin: 0 !important; min-width: 320px !important; max-width: 360px !important;
    }
    .popup-header { 
        background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; 
        padding: 12px 16px; font-size: 15px; font-weight: 700; line-height: 1.4;
    }
    .popup-body { padding: 0; max-height: 320px; overflow-y: auto; background: #fff; }
    .popup-table { width: 100%; border-collapse: collapse; }
    .popup-table tr { border-bottom: 1px solid #f1f5f9; transition: background 0.1s; }
    .popup-table tr:last-child { border-bottom: none; }
    .popup-table tr:hover { background: #f8fafc; }
    .popup-table td { padding: 8px 16px; font-size: 13px; line-height: 1.4; }
    .popup-key { color: #64748b; width: 40%; font-weight: 500; }
    .popup-val { color: #0f172a; font-weight: 600; text-align: right; word-break: break-word; }
    
    .leaflet-control-layers { display: none !important; }

/* Контейнер для логотипов и кнопки */
    .top-right-nav {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: row; /* Сама группа (логотипы + кнопка) в ряд */
        align-items: center;
        gap: 10px;
    }

    /* Контейнер чисто для логотипов, чтобы они стояли друг над другом */
    .logo-stack {
        display: flex;
        flex-direction: column; /* Логотипы один под другим */
        gap: 5px; /* Расстояние между логотипами */
    }

    .nav-logo-link {
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }

    .nav-logo-link:hover {
        transform: scale(1.1); /* Легкое увеличение при наведении */
    }

    .nav-logo-img {
        height: 28px; /* Уменьшенный размер */
        width: auto;
        border-radius: 0px;
        background: white;
        padding: 2px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        display: block;
    }

    .external-link-btn {
        position: static !important;
        margin: 0;
        height: fit-content; /* Чтобы кнопка не растягивалась по высоте логотипов */
    }

    .nav-logo-img {
        width: auto;
        border-radius: 4px;
        background: white;
        padding: 2px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        display: block;
    }

    /* Индивидуальные размеры */
    .logo-khc {
        height: 26px; /* Размер первого логотипа */
    }

    .logo-q88 {
        height: 19px; /* Сделали второй логотип заметно меньше */
    }

    .logo-stack {
        display: flex;
        flex-direction: column;
        gap: 4px;
        align-items: center; /* Центрируем их друг относительно друга */
    }
</style>
</head>
<body>

<div id="map"></div>

<div class="top-right-nav">
    <div class="logo-stack">
        <a href="https://homeportal.kz/" target="_blank" class="nav-logo-link">
            <img src="khc.png" alt="KHC" class="nav-logo-img logo-khc">
        </a>
        <a href="https://q88.kz/" target="_blank" class="nav-logo-link">
            <img src="q88.png" alt="Q88" class="nav-logo-img logo-q88">
        </a>
    </div>

    <a href="https://d05s4d1lbkwrkaccszekofu4-xe7ldl-7beih.github.io/kaz4-g2U1mXCZtrademap/" target="_blank" class="external-link-btn">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"></path></svg>
        Карта Казахстана
    </a>
</div>

<div class="basemap-switcher">
    <button class="basemap-btn active" id="btn-scheme" onclick="setBasemap('scheme')">Схема</button>
    <button class="basemap-btn" id="btn-sat" onclick="setBasemap('sat')">Спутник</button>
</div>

<div class="description-panel" id="descPanel">
    <div class="desc-header" onclick="toggleDescription()">
        <span class="desc-title" id="descTitle" style="margin-bottom:0; font-size:13px;">Заголовок</span>
        <span class="toggle-icon" id="descToggleBtn">▼</span>
    </div>
    <div id="descText">Текст описания...</div>
</div>

    <div class="chart-panel" id="chartPanel">
    <h4 id="chartTitle">Статистика</h4>
    <div class="chart-container">
        <canvas id="infoChart"></canvas>
    </div>
    
    <div id="crimeHotspotsPanel">
        <h4 style="margin: 0 0 8px 0; font-size: 12px; color: #881337;">Очаги активности:</h4>
        <div class="hotspot-buttons-container" id="hotspotButtons">
            </div>
        <div id="hotspotTextBox">Выберите зону выше для подробной информации.</div>
    </div>
</div>
</div>

<div class="metrics-control-left" id="accordion">
    
    <details>
        <summary>1. Общие сведения</summary>
        <div class="metrics-group">
            <button class="metric-btn active" data-type="cadastre" data-metric="cadastre">Земельные участки</button>
            <button class="metric-btn" data-type="districts" data-metric="density_popul">Плотность населения</button>
        </div>
    </details>

    <details>
        <summary>2. Безопасность и правопорядок</summary>
        <div class="metrics-group">
            <button class="metric-btn" data-type="districts" data-metric="crime_density">Плотность правонарушений</button>
            <button class="metric-btn" data-type="heat_crime" data-metric="crime_heat">Тепловая карта преступлений</button>
        </div>
    </details>

    <details>
        <summary>3. Экономика и торговля</summary>
        <div class="metrics-group">
            <button class="metric-btn" data-type="heat" data-metric="commercial">Коммерческая активность</button>
            <button class="metric-btn" data-type="districts" data-metric="real_estate">Недвижимость</button>
        </div>
    </details>

    <details>
        <summary>4. Строительство и инфраструктура</summary>
        <div class="metrics-group">
            <button class="metric-btn" data-type="builds" data-metric="level">Этажность зданий</button>
            <button class="metric-btn" data-type="builds" data-metric="year">Год постройки</button>
            <button class="metric-btn" data-type="districts" data-metric="density_gsi">Плотность застройки (GSI)</button>
            <button class="metric-btn" data-type="districts" data-metric="density_rds">Плотность УДС</button>
            
            <div style="height:1px; background:#e2e8f0; margin:4px 0;"></div>
            <button class="metric-btn" data-type="rm" data-metric="score_renov">Потенциал Реновации</button>
            <button class="metric-btn" data-type="rm" data-metric="score_modern">Потенциал Модернизации</button>
            
            <div style="height:1px; background:#e2e8f0; margin:4px 0;"></div>
            <button class="metric-btn" data-type="spsyntax" data-metric="spsyntax_int">Space Syntax: Интеграция</button>
            <button class="metric-btn" data-type="spsyntax" data-metric="spsyntax_ch">Space Syntax: Выбор</button>
            
            <div style="height:1px; background:#e2e8f0; margin:4px 0;"></div>
            <button class="metric-btn" data-type="transport" data-metric="transport">Общественный транспорт</button>
            <div id="routes-panel"></div>
        </div>
    </details>

    <details>
        <summary>5. Экология и природопользование</summary>
        <div class="metrics-group">
            <button class="metric-btn" disabled style="opacity:0.5; cursor: default;">Данные в разработке</button>
        </div>
    </details>

    <details>
        <summary>6. Социальное развитие и поддержка</summary>
        <div class="metrics-group">
            <button class="metric-btn" data-type="social" data-metric="schools">Школы</button>
            <button class="metric-btn" data-type="social" data-metric="detsad">Детские сады</button>
            <button class="metric-btn" data-type="social" data-metric="medical">Медицинские объекты</button>
            <button class="metric-btn" data-type="social" data-metric="college">Колледжи</button>
            <button class="metric-btn" data-type="social" data-metric="vuz">ВУЗы</button>
        </div>
    </details>
    
     <details>
        <summary>7. Культура и туризм</summary>
        <div class="metrics-group">
            <button class="metric-btn" disabled style="opacity:0.5; cursor: default;">Данные в разработке</button>
        </div>
    </details>

</div>

<div class="legend" id="legend"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

<script>
// --- Данные для диаграмм ---
const chartDataSources = {
    land: {
        labels: ["Инфраструктура", "Пром. и произв.", "Жилая застройка", "Садоводство", "Прочее"],
        values: [7920, 5746, 1634, 1541, 1518],
        colors: ['#64748b', '#94a3b8', '#3b82f6', '#10b981', '#cbd5e1']
    },
    crime: {
        labels: ["Кража", "Мошенничество", "Мелкое хищение", "Наркотики", "Причинение вреда"],
        values: [4701, 4025, 716, 480, 423],
        colors: ['#ef4444', '#f87171', '#fca5a5', '#fecaca', '#fee2e2']
    }
};

// --- Данные для горячих точек преступности ---
const crimeHotspotsData = [
    {
        name: "Каирбекова – Текстильщиков",
        coords: [53.2394460, 63.6800493], // Lat, Lng
        text: "Следует расположить пункт полиции в районе с плохой репутацией отдельных жилых домов"
    },
    {
        name: "Центральный рынок",
        coords: [53.2176678, 63.6449730],
        text: "Район с активной уличной и внеуличной торговлей часто является местом высокой криминогенности"
    },
    {
        name: "Абая – Наримановская",
        coords: [53.2012473, 63.6286329],
        text: "Новый район с высокой плотностью населения и отдельные увеселительные заведения должны находиться под наблюдением"
    },
    {
        name: "Образовательный кластер",
        coords: [53.1889429, 63.6121245],
        text: "Места концентрации высших и специальных учебных заведений вкупе с торговыми центрами могут быть источниками криминогенности"
    },
    {
        name: "Автовокзал",
        coords: [53.1708450, 63.5929743],
        text: "Железнодорожные и автовокзалы традиционно считаются местом с высоким уровнем преступности"
    }
];

// --- Текстовые описания ---
const descriptions = {
    level: "Большая часть городской территории занята домами 1–5 этажей (светло-розовые  и розовые участки). Высотки (от 12 этажей) — редкость и находятся только в ограниченных зонах, вероятно, вблизи ключевых транспортных узлов или административных центров.",
    year: "Центр города сформирован преимущественно зданиями советских лет (1957–1984) - это самый старый жилой фонд, который задает историческое и культурное ядро города. Спальные районы располагаются на северо - востоке и юго - западе. Эти кварталы появились волнами - от более ранних до позднесоветских и постсоветских застроек, что хорошо заметно по смене оттенков на карте. Здесь преобладает массовое жилищное строительство, рассчитанное на большие группы населения. Современный район на севере — самый новый и быстрорастущий, представлен крупными кварталами новостроек последних десятилетий. Это свидетельствует о смещении градостроительных акцентов и о развитии новых жилых массивов на свободных территориях",
    cadastre: "На долю инфраструктурных объектов (дороги, коммуникации, ЛЭП) приходится 38.3% площади, а на промышленные и производственные зоны — 27.8%. Вместе эти две категории составляют две трети всего земельного фонда, что характеризует территорию как значимый промышленный и логистический узел. При этом земли, непосредственно используемые населением для жизни и досуга, такие как жилая застройка (7.9%), парковые территории и садоводство (7.5%) и коммерция (6.0%), занимают значительно меньшую долю общей площади, что говорит о более интенсивном и концентрированном характере их использования.",
    density_popul: "Частный сектор между многоэтажными районами создает разрывы и препятствия в городской структуре. ИЖС сдерживает уплотнение и развитие центра, снижая эффективность использования дорогой городской земли. Для устойчивого городского развития такие разрывы нуждаются в реновации: можно создавать парки с общественной функцией, строить новые жилые или коммерческие здания, организовывать общественные пространства, которые бы «сшивали» ткани города и повышали человеческую активность на этих участках.",
    density_gsi: "Для города характерна сильная неоднородность по площади застройки разных участков. Высокий GSI не всегда означает интенсивную городскую жизнь: часто это промзоны или склады. Самые “жизненно насыщенные” участки — там, где высокий GSI совпадает с высокой плотностью населения и этажностью зданий. Видны участки для реновации, “разрывы” городской ткани, а также перспективные направления для рационального уплотнения городской структуры. Карта отлично подходит для начального анализа потенциала развития и выявления зон, требующих улучшения или комплексной реконструкции.",
    density_rds: "Улично-дорожная сеть в целом отражает этапность и специфику развития города: хорошую структуру в центре, достаточно рациональная сетка и новые районы с тенденцией к фрагментации и малой связанности. Ключевые проблемы: 1. Часть старых районов страдает от устаревшей инфраструктуры, которая не соответствует современным транспортным потокам. 2. Новые кварталы часто имеют слабую интеграцию с остальным городом, а транспортная сетка выполнена формально, что снижает связанность городской среды. 3. В промышленной периферии и транзитных зонах УДС становится барьером для пешеходов и городского развития.",
    transport: "Сеть общественного транспорта достаточно развита по основным магистралям и обеспечивает связность между крупными районами города, но слабо обрабатывает внутренние связи и окраины. 1. Жителям многих районов сложно пользоваться ОТ без лишних пересадок. 2. Текущая структура снижает транспортную гибкость и - на перспективу - требует развития локальных маршрутов, улучшения проникновения в глубокие и новые жилые массивы, а также интеграции с другими видами городской мобильности (пешие, велосипедные связи). 3 .Особое внимание стоит уделить развивающимся новым районам и зонам разрывов городской ткани, чтобы не допустить транспортной изоляции отдельных кварталов",
    crime_density: "Криминальная активность в городе наиболее выражена в наиболее насыщенных и транзитных районах - центр, крупные жилые массивы и ключевые транспортные коридоры. Малонаселенные и периферийные зоны остаются относительно спокойными. Это типичная ситуация для большинства городов: уровень правонарушений тесно зависит от концентрации людей и активности пространства. Для повышения безопасности в “красных” зонах необходим комплекс мер: развитие городской среды, освещение, видеонаблюдение, вовлечение людей в общественную жизнь и развитие инфраструктуры контроля.",
    crime_heat: "В структуре преступности преобладают имущественные правонарушения. На долю краж (ст. 188) приходится 39,2%, на мошенничество – 33,6%, что в совокупности составляет 72,8% от общего числа зарегистрированных деяний. По отдельным составам преступлений, в частности по умышленному причинению вреда здоровью средней тяжести (ст. 107), основная масса фактов (более 400) квалифицирована по части 1, что свидетельствует о преобладании составов без отягчающих обстоятельств.",
    commercial: "Данный слой визуализирует плотность и распределение коммерческой инфраструктуры, разделяя городскую территорию на зоны в зависимости от интенсивности бизнес-процессов и доступности услуг для населения: 1. Низкая интенсивность (Окраины и частный сектор): Характеризует территории с рассредоточенным расположением объектов, ориентированных исключительно на базовые нужды жителей. В этих зонах выбор товаров ограничен, а доступ к полноценному сервису требует использования транспорта. 2. Средняя интенсивность (Жилые массивы и магистрали): Типична для спальных районов со средней этажностью, где коммерция формирует устойчивые узлы вдоль главных дорог. Здесь достигается баланс между жилой средой и торговыми функциями, обеспечивающий повседневный и периодический спрос в пределах пешей доступности. 3. Высокая интенсивность (Деловые и транспортные узлы): Охватывает исторический центр города и зоны влияния крупных транспортных хабов. Это территории с максимальной концентрацией разнообразных коммерческих объектов и пиковой проходимостью, формирующие основной экономический каркас города.",
    real_estate: "Недвижимость с высокой стоимостью сконцентрирована преимущественно в центре города и в районах новой застройки.",
    schools: "В основном нехватка объектов связана с интенсивным строительством жилья в новых районах, где жилые функции появляются раньше, чем успевает развиться социальная и коммерческая инфраструктура. В результате новые кварталы заселяются, а социальные объекты строятся с заметным опозданием.",
    detsad: "В основном нехватка объектов связана с интенсивным строительством жилья в новых районах, где жилые функции появляются раньше, чем успевает развиться социальная и коммерческая инфраструктура. В результате новые кварталы заселяются, а социальные объекты строятся с заметным опозданием.",
    medical: "В основном нехватка объектов связана с интенсивным строительством жилья в новых районах, где жилые функции появляются раньше, чем успевает развиться социальная и коммерческая инфраструктура. В результате новые кварталы заселяются, а социальные объекты строятся с заметным опозданием.",
    college: "В основном нехватка объектов связана с интенсивным строительством жилья в новых районах, где жилые функции появляются раньше, чем успевает развиться социальная и коммерческая инфраструктура. В результате новые кварталы заселяются, а социальные объекты строятся с заметным опозданием.",
    vuz: "В основном нехватка объектов связана с интенсивным строительством жилья в новых районах, где жилые функции появляются раньше, чем успевает развиться социальная и коммерческая инфраструктура. В результате новые кварталы заселяются, а социальные объекты строятся с заметным опозданием.",
    
    // Текст для реновации и модернизации (общий, но можно разделить если нужно)
    score_renov: `
<div style="display: flex; gap: 15px; font-size: 11px; line-height: 1.4; margin-top: 5px;">
    <div style="flex: 1;">
        <div style="color: #2563eb; font-weight: 800; text-transform: uppercase; font-size: 9px; margin-bottom: 8px; border-bottom: 1px solid #dbeafe; padding-bottom: 4px;">
            Реновация (ИЖС → МЖК)
        </div>
        <div style="margin-bottom: 8px;"><b>У центра:</b> 92,9 Га.</div>
        <div style="margin-bottom: 8px;"><b>Доуплотнение:</b> 253,5 Га.</div>
        <div style="margin-bottom: 8px;"><b>Вокзал:</b> 36,4 Га.</div>
    </div>
</div>`,
    score_modern: "Анализ территорий на предмет потенциала модернизации существующей среды (без сноса).",
    
    spsyntax_int: "Space Syntax: Интеграция показывает глобальную доступность улицы во всей системе города. Высокие значения (светлые цвета) означают, что улица находится близко ко всем остальным.",
    spsyntax_ch: "Space Syntax: Выбор показывает, как часто улица используется как транзитный маршрут. Важно для коммерции."
};

// --- Алиасы полей ---
const fieldAliases = {
    'level': 'Этажность', 
    'tsn_ru': 'Целевое назначение', 
    'pricepersqm_avg': 'Цена за м²', 
    'year': 'Год постройки',
    'год ввода в эксплуатацию': 'Год постройки',
    'status': 'Тип', 
    'mkrn_name': 'Район',
    'density_popul': 'Плотность (чел/га)', 
    'density_gsi': 'GSI',
    'density_rds': 'УДС (км/км²)', 
    'crime_density': 'Инцидентов/га',
    'purpose': 'Назначение',
    'area': 'Площадь',
    'name': 'Название',
    'type': 'Тип',
    'kad_nomer': 'Кадастровый номер',
    'land_category': 'Категория земель',
    'sobstvennik': 'Наименование',
    'Adress': 'Адрес',
    'area_preza': 'Площадь',
    // Новые поля
    'score_renov': 'Потенциал реновации',
    'score_modern': 'Потенциал модернизации',
    'morphotype': 'Тип',
    'popul': 'Население',
    'modern': 'Модернизация',
    'renov': 'Реновация',
    'NAINr15000': 'Интеграция',
    'NACHr15000': 'Выбор'
};

// --- Canvas Renderer ---
const myRenderer = L.canvas({ padding: 0.5 });

// --- Инициализация карты ---
const map = L.map('map', { center: [53.214, 63.632], zoom: 12, zoomControl: false, preferCanvas: true });

map.createPane('polygonsPane'); map.getPane('polygonsPane').style.zIndex = 400;
map.createPane('linesPane'); map.getPane('linesPane').style.zIndex = 450; // Для линий Space Syntax
map.createPane('markerPane'); map.getPane('markerPane').style.zIndex = 600;

const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CARTO', maxZoom: 19 });
const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'], attribution: '© Google' });

cartoLight.addTo(map);
L.control.zoom({ position: 'topright' }).addTo(map);

function setBasemap(type) {
    if (type === 'scheme') {
        map.removeLayer(googleSat); map.addLayer(cartoLight);
        document.getElementById('btn-scheme').classList.add('active');
        document.getElementById('btn-sat').classList.remove('active');
    } else {
        map.removeLayer(cartoLight); map.addLayer(googleSat);
        document.getElementById('btn-sat').classList.add('active');
        document.getElementById('btn-scheme').classList.remove('active');
    }
}

// --- Конфигурация слоев ---
const config = {
    level: { 
        field: 'level', title: 'Этажность зданий', 
        breaks: [2, 5, 9, 19], colors: ['#fce7f3', '#f472b6', '#db2777', '#831843'], labels: ['1-2', '3-5', '6-9', '10+'] 
    },
    year: { 
        field: 'год ввода в эксплуатацию', title: 'Год постройки', 
        breaks: [1960, 1975, 1990, 2005, 2015, 2025],
        colors: ['#d1d5db', '#9ca3af', '#6b7280', '#fb923c', '#f97316', '#ea580c'],
        labels: ['<1960', '60-75', '75-90', '90-05', '05-15', '>2015']
    },
    real_estate: {
        field: 'pricepersqm_avg', title: 'Стоимость недвижимости за кв. м',
        breaks: [230000, 320000, 390000, 440000, 530000, 633000], 
        colors: ['#ffffcc', '#c7e9b4', '#7fcdbb', '#41b6c4', '#2c7fb8', '#253494'], 
        labels: ['<230k', '230-320', '320-390', '390-440', '440-530', '>530k']
    },
    cadastre: {
        field: 'objectid', title: 'Земельные участки', colors: ['#3b82f6'], labels: ['Границы участков']
    },
    
    // Обновленный GSI (Приглушенные синие)
    density_gsi: { 
        field: 'density_gsi', title: 'Плотность застройки', 
        breaks: [0.05, 0.15, 0.3, 0.5, 0.8], 
        colors: ['#f1f5f9', '#cbd5e1', '#93c5fd', '#60a5fa', '#3b82f6'],
        labels: ['<0.05', '0.05-0.15', '0.15-0.3', '0.3-0.5', '>0.5'] 
    },
    density_rds: { 
        field: 'density_rds', title: 'Плотность УДС', 
        breaks: [10, 25, 45, 65, 82], colors: ['#fafaf9', '#e7e5e4', '#a8a29e', '#57534e', '#292524'], labels: ['<10', '10-25', '25-45', '45-65', '>65'] 
    },

    // Реновация и модернизация (Градиенты 0-10)
    score_renov: {
        field: 'score_renov', title: 'Потенциал Реновации',
        breaks: [0, 2, 4, 6, 8, 10],
        colors: ['#fef2f2', '#fee2e2', '#fca5a5', '#f87171', '#ef4444', '#b91c1c'],
        labels: ['0', '2', '4', '6', '8', '10']
    },
    score_modern: {
        field: 'score_modern', title: 'Потенциал Модернизации',
        breaks: [0, 2, 4, 6, 8, 10],
        colors: ['#ecfdf5', '#d1fae5', '#6ee7b7', '#34d399', '#10b981', '#047857'],
        labels: ['0', '2', '4', '6', '8', '10']
    },

    // Space Syntax (Viridis)
    spsyntax_int: {
        field: 'NAINr15000', title: 'SS: Интеграция',
        breaks: [0.21, 0.62, 0.8, 0.96, 1.16, 1.45],
        // Viridis palette approximation
        colors: ['#440154', '#3b528b', '#21918c', '#5ec962', '#fde725'],
        labels: ['0.21', '0.62', '0.80', '0.96', '1.16+']
    },
    spsyntax_ch: {
        field: 'NACHr15000', title: 'SS: Выбор',
        breaks: [0.26, 0.69, 0.96, 1.18, 1.54],
        colors: ['#440154', '#3b528b', '#21918c', '#5ec962', '#fde725'],
        labels: ['0.26', '0.69', '0.96', '1.18+']
    },

    schools: { title: 'Школы (500м)', color: '#2563eb' },
    detsad: { title: 'Детсады (300м)', color: '#f97316' },
    medical: { title: 'Медицина', color: '#e11d48' },
    college: { title: 'Колледжи', color: '#4f46e5' },
    vuz: { title: 'ВУЗы', color: '#7e22ce' },

    density_popul: { 
        field: 'density_popul', title: 'Плотность населения', 
        breaks: [20, 60, 150, 300, 580], colors: ['#f0f9ff', '#bae6fd', '#38bdf8', '#0284c7', '#0c4a6e'], labels: ['<20', '20-60', '60-150', '150-300', '>300'] 
    },
    crime_density: { 
        field: 'crime_density', title: 'Плотность правонарушений', 
        breaks: [2, 8, 18, 26.5], colors: ['#fff1f2', '#fda4af', '#e11d48', '#881337'], labels: ['<2', '2-8', '8-18', '>18'] 
    },
    crime_heat: {
        title: 'Тепловая карта преступлений', subtitle: 'Концентрация инцидентов',
        gradient: { 0.2: '#0d0887', 0.4: '#7e03a8', 0.6: '#cc4778', 0.8: '#f89540', 1.0: '#f0f921' }
    },
    transport: { title: 'Общественный транспорт', subtitle: 'Маршруты и остановки' },
    commercial: { 
        title: 'Коммерческая активность', subtitle: 'Концентрация объектов', 
        gradient: { 0.4: '#d8b4fe', 0.7: '#a855f7', 1.0: '#581c87' } 
    }
};

let districtsLayer, buildsLayer, heatLayer, crimeHeatLayer, crimeHotspotsLayer, cadplotsLayer, busRoutesLayer, busStopsLayer, socialLayer, rmLayer, spsyntaxLayer;
let currentMetric = 'cadastre';
let currentType = 'cadastre'; 
let highlightedLayer = null;
let allRouteNames = [];
let myChart = null;
let slider = null;
let currentRange = [0, 10];

// Аккордеон
const details = document.querySelectorAll("details");
details.forEach((targetDetail) => {
    targetDetail.addEventListener("click", () => {
        details.forEach((detail) => { if (detail !== targetDetail) detail.removeAttribute("open"); });
    });
});

// --- Функции стиля ---
function getCategoryIndex(val, metric) {
    if (val == null) return -1;
    if (metric === 'cadastre') return 0;
    
    let num = NaN;
    const strVal = String(val);
    if (metric === 'year') {
        const match = strVal.match(/(\d{4})/);
        if (match) num = parseInt(match[0]);
    }
    if (isNaN(num)) num = parseFloat(strVal.replace(/[^\d.]/g, ''));
    if (isNaN(num)) return -1;

    const conf = config[metric];
    if (!conf.breaks) return 0;
    for (let i = 0; i < conf.breaks.length; i++) {
        if (num <= conf.breaks[i]) return i;
    }
    return conf.colors.length - 1; 
}

function style(feature) {
    if (currentMetric === 'cadastre') return { color: '#3b82f6', weight: 0.5, fillOpacity: 0.2, fillColor: '#3b82f6', interactive: true };
    
    // Space Syntax (Lines)
    if (currentType === 'spsyntax') {
        const conf = config[currentMetric];
        const val = feature.properties[conf.field];
        const catIndex = getCategoryIndex(val, currentMetric);
        const color = (catIndex >= 0) ? conf.colors[catIndex] : '#ccc';
        return { color: color, weight: 3, opacity: 1, interactive: true };
    }

    // Renovation/Modernization
    if (currentType === 'rm') {
        const conf = config[currentMetric];
        const val = feature.properties[conf.field]; // score_renov or score_modern
        // If 0, make transparent? Or just low color. Let's strictly use scale.
        const catIndex = getCategoryIndex(val, currentMetric);
        const color = (catIndex >= 0) ? conf.colors[catIndex] : '#f1f5f9';
        return {
             fillColor: color, weight: 0.5, opacity: 1, color: '#94a3b8', fillOpacity: 0.8, interactive: true
        };
    }

    const conf = config[currentMetric];
    if (!conf) return {};

    const val = feature.properties[conf.field];
    const catIndex = getCategoryIndex(val, currentMetric);
    
    const isVisible = (catIndex >= currentRange[0] && catIndex <= currentRange[1]) || catIndex === -1; 
    
    if (catIndex === -1) {
        return { fillColor: '#f1f5f9', weight: 0, opacity: 0, color: 'transparent', fillOpacity: 0.2, interactive: true };
    }

    const color = conf.colors[catIndex];
    const strokeWidth = (currentType === 'builds') ? 0.2 : 0.8;

    return { 
        fillColor: color, 
        weight: strokeWidth, 
        opacity: isVisible ? 1 : 0.1, 
        color: '#64748b', 
        fillOpacity: isVisible ? 0.9 : 0.1,
        interactive: true
    };
}

function updateLayerStyle() {
    const layerMap = { 
        'districts': districtsLayer, 'builds': buildsLayer, 'cadastre': cadplotsLayer, 
        'rm': rmLayer, 'spsyntax': spsyntaxLayer 
    };
    const layer = layerMap[currentType];
    if (layer) layer.eachLayer(l => l.setStyle(style(l.feature)));
}

// --- Попапы ---
function onEachFeature(feature, layer) {
    const props = feature.properties;
    if (currentType === 'social' && feature.geometry.type === 'Polygon') return; 
    if (currentType === 'transport' && feature.geometry.type === 'LineString') return;

    layer.on({
        click: (e) => {
            if (highlightedLayer && map.hasLayer(highlightedLayer) && highlightedLayer.setStyle && currentType !== 'social') {
                try { highlightedLayer.setStyle(style(highlightedLayer.feature)); } catch(err) {}
            }
            highlightedLayer = e.target;
            if (highlightedLayer.setStyle) {
                highlightedLayer.setStyle({ weight: 3, color: '#000', fillOpacity: 1 });
                if (!L.Browser.ie && currentType !== 'social' && highlightedLayer.bringToFront) highlightedLayer.bringToFront();
            }
        }
    });

    let title = 'Объект';
    if (props['Адрес жилого дома']) title = props['Адрес жилого дома'];
    else if (props['Адрес жилого дома_max_max']) title = props['Адрес жилого дома_max_max'];
    else if (props['sobstvennik']) title = props['sobstvennik'];
    else if (props['name']) title = props['name'];
    else if (props['mkrn_name']) title = props['mkrn_name'];

    let rows = '';

    if (currentType === 'transport' && props.routes_sum) {
        title = props.name;
        rows += `<tr><td class="popup-key">Маршрутов:</td><td class="popup-val">${props.routes_sum}</td></tr>`;
    }
    else {
        const exclude = ['gid', 'objectid', 'id', 'Адрес жилого дома', 'Адрес жилого дома_max_max', 'sobstvennik', 'name'];
        for (const [key, value] of Object.entries(props)) {
            if (value == null || exclude.includes(key)) continue;
            
            // Специальная обработка для modern/renov - только значение
            if (key === 'modern' || key === 'renov') {
                rows += `<tr><td colspan="2" style="padding:10px 16px; font-weight:700; color:#333; text-align:center; background:#f8fafc;">${value}</td></tr>`;
                continue;
            }

            let alias = fieldAliases[key] || key;
            if (!fieldAliases[key]) alias = alias.replace('_max_max', '');
            rows += `<tr><td class="popup-key">${alias}:</td><td class="popup-val">${value}</td></tr>`;
        }
    }
    
    layer.bindPopup(`<div class="popup-header">${title}</div><div class="popup-body"><table class="popup-table">${rows}</table></div>`);
}

// --- Легенда ---
function updateLegend() {
    const legend = document.getElementById('legend');
    const conf = config[currentMetric];
    
    if (currentType.includes('heat') || currentType === 'transport' || currentType === 'cadastre' || currentType === 'social') {
        if(slider) { slider.destroy(); slider = null; }
        let content = `<div class="legend-title">${conf.title}</div><div style="font-size:11px;margin-bottom:8px;color:#666">${conf.subtitle || ''}</div>`;
        
        if (conf.gradient) {
             const grad = `linear-gradient(to right, ${Object.values(conf.gradient).join(', ')})`;
             content += `<div style="background:${grad};height:12px;border-radius:6px;width:100%;"></div><div class="legend-labels"><span>Мин.</span><span>Макс.</span></div>`;
        } 
        else if (currentType === 'transport') {
             content += `<div class="legend-item"><div style="width:12px;height:12px;border-radius:50%;background:#94a3b8;border:1px solid #9c9c9c;opacity:0.8"></div> Остановка</div>`;
             content += `<div class="legend-item"><div style="width:20px;height:4px;background:#3b82f6;"></div> Маршрут</div>`;
        } 
        else if (currentType === 'cadastre') {
             content += `<div class="legend-item"><div class="legend-color" style="background:#3b82f6"></div> Границы участков</div>`;
        }
        else if (currentType === 'social') {
             content += `<div class="legend-item"><div style="width:10px;height:10px;border-radius:50%;background:${conf.color};"></div> Объект</div>`;
        }
        legend.innerHTML = content;
        return;
    }

    const steps = conf.colors.length;
    currentRange = [0, steps - 1];
    
    let html = `<div class="legend-title">${conf.title}</div>`;
    html += `<div id="slider-container"></div>`;
    html += `<div class="legend-labels" id="slider-values"></div>`;
    html += `<div style="display:flex; height:8px; margin-top:5px; border-radius:4px; overflow:hidden">`;
    conf.colors.forEach(c => { html += `<div style="flex:1; background:${c}"></div>`; });
    html += `</div>`;

    legend.innerHTML = html;

    const sliderDOM = document.getElementById('slider-container');
    noUiSlider.create(sliderDOM, {
        start: [0, steps - 1],
        connect: true,
        step: 1,
        range: { 'min': 0, 'max': steps - 1 }
    });
    
    slider = sliderDOM.noUiSlider;
    const valDiv = document.getElementById('slider-values');
    
    slider.on('update', function (values) {
        const i1 = Math.round(values[0]);
        const i2 = Math.round(values[1]);
        currentRange = [i1, i2];
        const l1 = conf.labels[i1] || conf.breaks[i1];
        const l2 = conf.labels[i2] || conf.breaks[i2];
        valDiv.innerHTML = `<span>${l1}</span><span>${l2}</span>`;
        updateLayerStyle();
    });
}

function toggleDescription() {
    const text = document.getElementById('descText');
    const btn = document.getElementById('descToggleBtn');
    if (text.style.display === 'none' || text.style.display === '') {
        text.style.display = 'block'; btn.classList.add('active'); btn.innerText = '▲';
    } else {
        text.style.display = 'none'; btn.classList.remove('active'); btn.innerText = '▼';
    }
}

function renderHotspotButtons() {
    const container = document.getElementById('hotspotButtons');
    const textBox = document.getElementById('hotspotTextBox');
    container.innerHTML = ''; // Очистка

    crimeHotspotsData.forEach((spot, index) => {
        const btn = document.createElement('button');
        btn.className = 'hotspot-btn';
        btn.innerText = spot.name;
        
        btn.onclick = () => {
            // Сброс активного класса у всех
            document.querySelectorAll('.hotspot-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Перелет камеры (zoom 15 для детального просмотра)
            map.flyTo(spot.coords, 15, {
                animate: true,
                duration: 1.2
            });
            
            // Обновление текста
            textBox.innerHTML = `<strong>${spot.name}:</strong><br>${spot.text}`;
        };
        
        container.appendChild(btn);
    });
}

function updateInfoPanel() {
    const panel = document.getElementById('descPanel');
    const text = document.getElementById('descText');
    const btn = document.getElementById('descToggleBtn');

    panel.style.display = 'block'; text.style.display = 'none'; btn.classList.remove('active'); btn.innerText = '▼';
    document.getElementById('descTitle').innerText = config[currentMetric].title;
    document.getElementById('descText').innerHTML = descriptions[currentMetric] || "Описание отсутствует";

    const chartPanel = document.getElementById('chartPanel');
    const hotspotsPanel = document.getElementById('crimeHotspotsPanel'); // Получаем панель кнопок
    const ctx = document.getElementById('infoChart');
    let chartData = null;

    if (currentMetric === 'cadastre') chartData = chartDataSources.land;
    else if (currentMetric === 'crime_heat') chartData = chartDataSources.crime;

    // Логика отображения диаграммы
    if (chartData) {
        chartPanel.style.display = 'block';
        document.getElementById('chartTitle').innerText = (currentMetric==='cadastre') ? "Земельный фонд (га)" : "Топ преступлений";
        
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: chartData.labels, datasets: [{ data: chartData.values, backgroundColor: chartData.colors, borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 9 } } } } }
        });
    } else {
        // Если данных для диаграммы нет, скрываем всю панель, если это не crime_heat
        // (но для crime_heat у нас есть диаграмма, так что этот блок сработает корректно)
        chartPanel.style.display = 'none';
    }

    // --- НОВАЯ ЛОГИКА ДЛЯ ПАНЕЛИ ПРЕСТУПЛЕНИЙ ---
    if (currentMetric === 'crime_heat') {
        chartPanel.style.display = 'block'; // Принудительно показываем панель
        hotspotsPanel.style.display = 'block'; // Показываем кнопки
        renderHotspotButtons(); // Генерируем кнопки (можно вызывать один раз, но здесь безопаснее)
    } else {
        hotspotsPanel.style.display = 'none'; // Скрываем кнопки в других режимах
    }
}

function createSocialLayer(geojson, type) {
    if (!socialLayer) socialLayer = L.layerGroup();
    socialLayer.clearLayers();
    const conf = config[type];
    const color = conf.color;
    const radius = (type === 'schools') ? 500 : (type === 'detsad' ? 300 : 0);
    
    geojson.features.forEach(f => {
        const latlng = [f.geometry.coordinates[1], f.geometry.coordinates[0]];
        if (radius > 0) L.circle(latlng, { radius: radius, color: color, fillColor: color, fillOpacity: 0.1, weight: 1, dashArray: '5, 5', interactive: false }).addTo(socialLayer);
        L.circleMarker(latlng, { radius: 7, color: '#fff', fillColor: color, fillOpacity: 1, weight: 2, pane: 'markerPane' }).addTo(socialLayer).bindPopup(() => {
            const p = f.properties;
            return `<div class="popup-header" style="background:${color}">${p.sobstvennik||p.name||'Объект'}</div><div class="popup-body" style="padding:10px 15px;"><div style="font-size:12px;color:#888;">Адрес</div><div style="font-weight:600;">${p.Adress||p.address||'-'}</div></div>`;
        });
    });
}

// --- Загрузка ---
Promise.all([
    fetch('kostanay_districts.geojson').then(r=>r.json()),
    fetch('kostanay_builds.geojson').then(r=>r.json()),
    fetch('kostanay_poi.geojson').then(r=>r.json()),
    fetch('kostanay_bus_routes.geojson').then(r=>r.json()),
    fetch('kostanay_bus_stops.geojson').then(r=>r.json()),
    fetch('kostanay_cadplots.geojson').then(r=>r.json()),
    fetch('kostanay_crime.geojson').then(r=>r.json()),
    fetch('kostanay_crime_hotspots.geojson').then(r=>r.json()),
    fetch('kostanay_schools.geojson').then(r=>r.json()),
    fetch('kostanay_detsad.geojson').then(r=>r.json()),
    fetch('kostanay_medical.geojson').then(r=>r.json()),
    fetch('kostanay_college.geojson').then(r=>r.json()),
    fetch('kostanay_vuz.geojson').then(r=>r.json()),
    fetch('kostanay_rm.geojson').then(r=>r.json()),
    fetch('kostanay_spsyntax.geojson').then(r=>r.json())
]).then(([districts, builds, poi, routes, stops, cadplots, crime, hotspots, schools, detsad, medical, college, vuz, rm, spsyntax]) => {

    districtsLayer = L.geoJSON(districts, { style: style, onEachFeature: onEachFeature, renderer: myRenderer, pane: 'polygonsPane' });
    buildsLayer = L.geoJSON(builds, { style: style, onEachFeature: onEachFeature, renderer: myRenderer, pane: 'polygonsPane' });
    cadplotsLayer = L.geoJSON(cadplots, { style: style, onEachFeature: onEachFeature, renderer: myRenderer, pane: 'polygonsPane' });
    rmLayer = L.geoJSON(rm, { style: style, onEachFeature: onEachFeature, renderer: myRenderer, pane: 'polygonsPane' });
    spsyntaxLayer = L.geoJSON(spsyntax, { style: style, onEachFeature: onEachFeature, renderer: myRenderer, pane: 'linesPane' });

    window.socialData = { schools, detsad, medical, college, vuz };

    const heatPoints = poi.features.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0], 0.3]);
    heatLayer = L.heatLayer(heatPoints, { radius: 15, blur: 18, gradient: config.commercial.gradient });

    const crimePoints = crime.features.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0], 0.5]);
    crimeHeatLayer = L.heatLayer(crimePoints, { radius: 20, blur: 15, gradient: config.crime_heat.gradient });
    
    crimeHotspotsLayer = L.geoJSON(hotspots, { pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 5, color: '#fff', fillColor: '#b91c1c', fillOpacity: 1, weight: 1, pane: 'markerPane' }), onEachFeature: onEachFeature });

    busRoutesLayer = L.geoJSON(routes, { style: { color: '#3b82f6', weight: 4, opacity: 0.2 }, onEachFeature: onEachFeature, pane: 'polygonsPane' });
    busStopsLayer = L.geoJSON(stops, {
        pointToLayer: (f, latlng) => {
             const r = 2 + (f.properties.routes_sum || 0)/4; 
             return L.circleMarker(latlng, { radius: Math.min(r, 8), color: '#9c9c9c', fillColor: '#94a3b8', fillOpacity: 0.8, weight: 1, pane: 'markerPane' });
        }, onEachFeature: onEachFeature
    });
    
    const routesSet = new Set();
    routes.features.forEach(f => { if(f.properties.name) routesSet.add(f.properties.name.toString()); });
    allRouteNames = Array.from(routesSet).sort((a,b)=> a.localeCompare(b, undefined, {numeric:true}));
    const rp = document.getElementById('routes-panel');
    allRouteNames.forEach(n => {
        const b = document.createElement('button'); b.className = 'route-select-btn'; b.innerText = n;
        b.onclick = () => {
            busRoutesLayer.eachLayer(l => {
                if(l.feature.properties.name == n) { l.setStyle({color:'#ea580c', weight:6, opacity:1}); l.bringToFront(); }
                else l.setStyle({color:'#3b82f6', weight:4, opacity:0.1});
            });
            document.querySelectorAll('.route-select-btn').forEach(btn=>btn.classList.remove('active')); b.classList.add('active');
        };
        rp.appendChild(b);
    });

    switchMode('cadastre', 'cadastre');

}).catch(e => console.error("Ошибка загрузки данных:", e));

function switchMode(metric, type) {
    highlightedLayer = null; map.closePopup();
    currentMetric = metric; currentType = type;

    [districtsLayer, buildsLayer, heatLayer, crimeHeatLayer, crimeHotspotsLayer, cadplotsLayer, busRoutesLayer, busStopsLayer, socialLayer, rmLayer, spsyntaxLayer].forEach(l => {
        if(l && map.hasLayer(l)) map.removeLayer(l);
    });

    if (type === 'districts') { updateLayerStyle(); map.addLayer(districtsLayer); }
    else if (type === 'builds') { updateLayerStyle(); map.addLayer(buildsLayer); }
    else if (type === 'cadastre') { updateLayerStyle(); map.addLayer(cadplotsLayer); }
    else if (type === 'rm') { updateLayerStyle(); map.addLayer(rmLayer); }
    else if (type === 'spsyntax') { updateLayerStyle(); map.addLayer(spsyntaxLayer); }
    else if (type === 'heat') map.addLayer(heatLayer);
    else if (type === 'heat_crime') { map.addLayer(crimeHeatLayer); map.addLayer(crimeHotspotsLayer); }
    else if (type === 'transport') { map.addLayer(busRoutesLayer); map.addLayer(busStopsLayer); document.getElementById('routes-panel').style.display = 'flex'; } 
    else if (type === 'social') { createSocialLayer(window.socialData[metric], metric); map.addLayer(socialLayer); }

    if (type !== 'transport') document.getElementById('routes-panel').style.display = 'none';
    updateLegend(); updateInfoPanel();
}

document.querySelectorAll('.metric-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        document.querySelectorAll('.metric-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        switchMode(e.target.dataset.metric, e.target.dataset.type);
    });
});
</script>
</body>
</html>
